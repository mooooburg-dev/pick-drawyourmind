name: ìë™ MAIN ë°°í¬ ë¨¸ì§€

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    if: startsWith(github.head_ref, 'feature/local')

    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci

    - name: ë¦°íŒ… ê²€ì‚¬
      run: npm run lint || true

    - name: ë¹Œë“œ í…ŒìŠ¤íŠ¸
      run: npm run build

    - name: ë¹Œë“œ ì„±ê³µ ìƒíƒœ ì—…ë°ì´íŠ¸
      if: success()
      run: |
        echo "âœ… ë¹Œë“œê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ğŸš€ ë°°í¬ ì¤€ë¹„ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."

  auto-approve-and-merge:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: success() && startsWith(github.head_ref, 'feature/local')
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: PR ìë™ ìŠ¹ì¸
      uses: juliangruber/approve-pull-request-action@v2
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        number: ${{ github.event.number }}

    - name: PR ìë™ ë¨¸ì§€
      uses: pascalgn/merge-action@v0.15.6
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        merge_method: squash
        merge_commit_message: |
          ğŸš€ MAIN ë°°í¬: feature/local â†’ main

          ìë™ ë°°í¬ëœ ë³€ê²½ì‚¬í•­:
          ${{ github.event.pull_request.body }}

    - name: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      if: success()
      run: |
        echo "ğŸ‰ MAIN ë¸Œëœì¹˜ë¡œ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "â° ë°°í¬ ì‹œê°„: $(date +'%Y-%m-%d %H:%M:%S')"
        echo "ğŸ”— ë°°í¬ëœ ë³€ê²½ì‚¬í•­: ${{ github.event.pull_request.html_url }}"