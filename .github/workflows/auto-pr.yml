name: 자동 MAIN 배포 PR 생성

on:
  push:
    branches: [ feature/local ]

jobs:
  create-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
    - name: 코드 체크아웃
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: main 브랜치와의 차이점 분석
      id: changes
      run: |
        # main 브랜치와 비교하여 커밋 목록 가져오기
        git fetch origin main:main || echo "main 브랜치 페치 실패, 계속 진행"

        # main과 feature/local 간의 차이점 분석
        if git rev-parse --verify main >/dev/null 2>&1; then
          COMMITS=$(git log --oneline main..HEAD --pretty=format:"- %s" | head -20)
        else
          # main 브랜치가 없는 경우 최근 10개 커밋 사용
          COMMITS=$(git log --oneline -10 --pretty=format:"- %s")
        fi

        # 빈 커밋 목록 처리
        if [ -z "$COMMITS" ]; then
          COMMITS="- 새로운 기능 및 개선사항"
        fi

        # 다중 라인 출력을 위한 EOF 사용
        echo "commits<<EOF" >> $GITHUB_OUTPUT
        echo "$COMMITS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

        # 변경된 파일 목록
        if git rev-parse --verify main >/dev/null 2>&1; then
          CHANGED_FILES=$(git diff --name-only main..HEAD | head -15 | sed 's/^/- /')
        else
          CHANGED_FILES=$(git diff --name-only HEAD~1..HEAD | head -15 | sed 's/^/- /')
        fi

        if [ -z "$CHANGED_FILES" ]; then
          CHANGED_FILES="- 다양한 파일 수정 및 개선"
        fi

        echo "changed_files<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: 날짜 및 시간 설정
      id: date
      run: |
        echo "current_date=$(date +'%Y년 %m월 %d일')" >> $GITHUB_OUTPUT
        echo "current_time=$(date +'%H:%M')" >> $GITHUB_OUTPUT

    - name: GitHub CLI 설치
      run: |
        # Ubuntu에 GitHub CLI 설치
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
        && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
        && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
        && sudo apt update \
        && sudo apt install gh -y

    - name: GitHub CLI 인증
      run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

    - name: 기존 PR 확인 및 생성
      run: |
        # 기존 PR 확인
        if gh pr list --head feature/local --base main --json number --jq '. | length' | grep -q "0"; then
          echo "새 PR 생성 중..."

          # PR 본문 생성
          PR_BODY=$(cat << 'EOF'
        ## 📋 배포 내용

        **배포 일시:** ${{ steps.date.outputs.current_date }} ${{ steps.date.outputs.current_time }}
        **배포 브랜치:** \`feature/local\` → \`main\`

        ## ✨ 주요 변경사항

        ${{ steps.changes.outputs.commits }}

        ## 📁 수정된 파일들

        ${{ steps.changes.outputs.changed_files }}

        ## 🔍 배포 전 체크리스트

        - [ ] 모든 기능이 정상적으로 작동하는지 확인
        - [ ] 빌드가 성공적으로 완료되는지 확인
        - [ ] 캐시 무효화 시스템이 정상 작동하는지 확인
        - [ ] Open Graph 이미지가 올바르게 표시되는지 확인
        - [ ] 모바일 반응형이 정상적으로 작동하는지 확인

        ## 🚀 배포 후 확인사항

        - [ ] 메인 페이지 로딩 확인
        - [ ] 블로그 페이지 정상 동작 확인
        - [ ] 관리자 페이지 기능 확인
        - [ ] SEO 메타태그 정상 출력 확인
        - [ ] 소셜 미디어 공유 시 OG 이미지 정상 표시 확인

        ---
        *이 PR은 자동으로 생성되었습니다. 🤖*
        EOF
        )

          # PR 생성
          gh pr create \
            --title "🚀 MAIN 배포" \
            --body "$PR_BODY" \
            --head feature/local \
            --base main

          echo "✅ PR이 성공적으로 생성되었습니다!"
        else
          echo "⚠️ feature/local → main PR이 이미 존재합니다."
          echo "기존 PR 목록:"
          gh pr list --head feature/local --base main
        fi

    - name: PR 생성 완료 알림
      run: |
        echo "🎉 MAIN 배포 PR이 성공적으로 생성되었습니다!"
        echo "📅 생성 시간: $(date +'%Y-%m-%d %H:%M:%S')"