name: ìë™ MAIN ë°°í¬ PR ìƒì„±

on:
  push:
    branches: [ feature/local ]

jobs:
  create-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: main ë¸Œëœì¹˜ì™€ì˜ ì°¨ì´ì  ë¶„ì„
      id: changes
      run: |
        # main ë¸Œëœì¹˜ì™€ ë¹„êµí•˜ì—¬ ì»¤ë°‹ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        git fetch origin main:main || echo "main ë¸Œëœì¹˜ í˜ì¹˜ ì‹¤íŒ¨, ê³„ì† ì§„í–‰"

        # mainê³¼ feature/local ê°„ì˜ ì°¨ì´ì  ë¶„ì„
        if git rev-parse --verify main >/dev/null 2>&1; then
          COMMITS=$(git log --oneline main..HEAD --pretty=format:"- %s" | head -20)
        else
          # main ë¸Œëœì¹˜ê°€ ì—†ëŠ” ê²½ìš° ìµœê·¼ 10ê°œ ì»¤ë°‹ ì‚¬ìš©
          COMMITS=$(git log --oneline -10 --pretty=format:"- %s")
        fi

        # ë¹ˆ ì»¤ë°‹ ëª©ë¡ ì²˜ë¦¬
        if [ -z "$COMMITS" ]; then
          COMMITS="- ìƒˆë¡œìš´ ê¸°ëŠ¥ ë° ê°œì„ ì‚¬í•­"
        fi

        # ë‹¤ì¤‘ ë¼ì¸ ì¶œë ¥ì„ ìœ„í•œ EOF ì‚¬ìš©
        echo "commits<<EOF" >> $GITHUB_OUTPUT
        echo "$COMMITS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

        # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡
        if git rev-parse --verify main >/dev/null 2>&1; then
          CHANGED_FILES=$(git diff --name-only main..HEAD | head -15 | sed 's/^/- /')
        else
          CHANGED_FILES=$(git diff --name-only HEAD~1..HEAD | head -15 | sed 's/^/- /')
        fi

        if [ -z "$CHANGED_FILES" ]; then
          CHANGED_FILES="- ë‹¤ì–‘í•œ íŒŒì¼ ìˆ˜ì • ë° ê°œì„ "
        fi

        echo "changed_files<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: ë‚ ì§œ ë° ì‹œê°„ ì„¤ì •
      id: date
      run: |
        echo "current_date=$(date +'%Yë…„ %mì›” %dì¼')" >> $GITHUB_OUTPUT
        echo "current_time=$(date +'%H:%M')" >> $GITHUB_OUTPUT

    - name: GitHub CLI ì„¤ì¹˜
      run: |
        # Ubuntuì— GitHub CLI ì„¤ì¹˜
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
        && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
        && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
        && sudo apt update \
        && sudo apt install gh -y

    - name: GitHub CLI ì¸ì¦
      run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

    - name: ê¸°ì¡´ PR í™•ì¸ ë° ìƒì„±
      run: |
        # ê¸°ì¡´ PR í™•ì¸
        if gh pr list --head feature/local --base main --json number --jq '. | length' | grep -q "0"; then
          echo "ìƒˆ PR ìƒì„± ì¤‘..."

          # PR ë³¸ë¬¸ ìƒì„±
          PR_BODY=$(cat << 'EOF'
        ## ğŸ“‹ ë°°í¬ ë‚´ìš©

        **ë°°í¬ ì¼ì‹œ:** ${{ steps.date.outputs.current_date }} ${{ steps.date.outputs.current_time }}
        **ë°°í¬ ë¸Œëœì¹˜:** \`feature/local\` â†’ \`main\`

        ## âœ¨ ì£¼ìš” ë³€ê²½ì‚¬í•­

        ${{ steps.changes.outputs.commits }}

        ## ğŸ“ ìˆ˜ì •ëœ íŒŒì¼ë“¤

        ${{ steps.changes.outputs.changed_files }}

        ## ğŸ” ë°°í¬ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸

        - [ ] ëª¨ë“  ê¸°ëŠ¥ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸
        - [ ] ë¹Œë“œê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ëŠ”ì§€ í™•ì¸
        - [ ] ìºì‹œ ë¬´íš¨í™” ì‹œìŠ¤í…œì´ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸
        - [ ] Open Graph ì´ë¯¸ì§€ê°€ ì˜¬ë°”ë¥´ê²Œ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸
        - [ ] ëª¨ë°”ì¼ ë°˜ì‘í˜•ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸

        ## ğŸš€ ë°°í¬ í›„ í™•ì¸ì‚¬í•­

        - [ ] ë©”ì¸ í˜ì´ì§€ ë¡œë”© í™•ì¸
        - [ ] ë¸”ë¡œê·¸ í˜ì´ì§€ ì •ìƒ ë™ì‘ í™•ì¸
        - [ ] ê´€ë¦¬ì í˜ì´ì§€ ê¸°ëŠ¥ í™•ì¸
        - [ ] SEO ë©”íƒ€íƒœê·¸ ì •ìƒ ì¶œë ¥ í™•ì¸
        - [ ] ì†Œì…œ ë¯¸ë””ì–´ ê³µìœ  ì‹œ OG ì´ë¯¸ì§€ ì •ìƒ í‘œì‹œ í™•ì¸

        ---
        *ì´ PRì€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ¤–*
        EOF
        )

          # PR ìƒì„±
          gh pr create \
            --title "ğŸš€ MAIN ë°°í¬" \
            --body "$PR_BODY" \
            --head feature/local \
            --base main

          echo "âœ… PRì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"
        else
          echo "âš ï¸ feature/local â†’ main PRì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤."
          echo "ê¸°ì¡´ PR ëª©ë¡:"
          gh pr list --head feature/local --base main
        fi

    - name: PR ìƒì„± ì™„ë£Œ ì•Œë¦¼
      run: |
        echo "ğŸ‰ MAIN ë°°í¬ PRì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ğŸ“… ìƒì„± ì‹œê°„: $(date +'%Y-%m-%d %H:%M:%S')"