name: ìë™ MAIN ë°°í¬ PR ìƒì„±

on:
  push:
    branches: [ feature/local ]

jobs:
  create-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: main ë¸Œëœì¹˜ì™€ì˜ ì°¨ì´ì  ë¶„ì„
      id: changes
      run: |
        # main ë¸Œëœì¹˜ì™€ ë¹„êµí•˜ì—¬ ì»¤ë°‹ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        git fetch origin main:main || echo "main ë¸Œëœì¹˜ í˜ì¹˜ ì‹¤íŒ¨, ê³„ì† ì§„í–‰"

        # mainê³¼ feature/local ê°„ì˜ ì°¨ì´ì  ë¶„ì„
        if git rev-parse --verify main >/dev/null 2>&1; then
          COMMITS=$(git log --oneline main..HEAD --pretty=format:"- %s" | head -20)
        else
          # main ë¸Œëœì¹˜ê°€ ì—†ëŠ” ê²½ìš° ìµœê·¼ 10ê°œ ì»¤ë°‹ ì‚¬ìš©
          COMMITS=$(git log --oneline -10 --pretty=format:"- %s")
        fi

        # ë¹ˆ ì»¤ë°‹ ëª©ë¡ ì²˜ë¦¬
        if [ -z "$COMMITS" ]; then
          COMMITS="- ìƒˆë¡œìš´ ê¸°ëŠ¥ ë° ê°œì„ ì‚¬í•­"
        fi

        # ë‹¤ì¤‘ ë¼ì¸ ì¶œë ¥ì„ ìœ„í•œ EOF ì‚¬ìš©
        echo "commits<<EOF" >> $GITHUB_OUTPUT
        echo "$COMMITS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

        # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡
        if git rev-parse --verify main >/dev/null 2>&1; then
          CHANGED_FILES=$(git diff --name-only main..HEAD | head -15 | sed 's/^/- /')
        else
          CHANGED_FILES=$(git diff --name-only HEAD~1..HEAD | head -15 | sed 's/^/- /')
        fi

        if [ -z "$CHANGED_FILES" ]; then
          CHANGED_FILES="- ë‹¤ì–‘í•œ íŒŒì¼ ìˆ˜ì • ë° ê°œì„ "
        fi

        echo "changed_files<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: ë‚ ì§œ ë° ì‹œê°„ ì„¤ì •
      id: date
      run: |
        echo "current_date=$(date +'%Yë…„ %mì›” %dì¼')" >> $GITHUB_OUTPUT
        echo "current_time=$(date +'%H:%M')" >> $GITHUB_OUTPUT

    - name: ê¸°ì¡´ PR í™•ì¸
      id: check_existing_pr
      run: |
        # GitHub APIë¡œ ê¸°ì¡´ PR í™•ì¸
        EXISTING_PR=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ github.repository }}/pulls?head=${{ github.repository_owner }}:feature/local&base=main&state=open")

        PR_COUNT=$(echo "$EXISTING_PR" | jq '. | length')
        echo "existing_pr_count=$PR_COUNT" >> $GITHUB_OUTPUT

        if [ "$PR_COUNT" -gt 0 ]; then
          PR_URL=$(echo "$EXISTING_PR" | jq -r '.[0].html_url')
          echo "existing_pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "ê¸°ì¡´ PRì´ ì¡´ì¬í•©ë‹ˆë‹¤: $PR_URL"
        else
          echo "ê¸°ì¡´ PRì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤."
        fi

    - name: PR ë³¸ë¬¸ ì¤€ë¹„
      id: pr_body
      if: steps.check_existing_pr.outputs.existing_pr_count == '0'
      run: |
        # PR ë³¸ë¬¸ ìƒì„± (GitHub Actions ë³€ìˆ˜ ì¹˜í™˜ í¬í•¨)
        cat > pr_body_template.md << 'EOF'
        ## ğŸ“‹ ë°°í¬ ë‚´ìš©

        **ë°°í¬ ì¼ì‹œ:** DEPLOY_DATE DEPLOY_TIME
        **ë°°í¬ ë¸Œëœì¹˜:** `feature/local` â†’ `main`

        ## âœ¨ ì£¼ìš” ë³€ê²½ì‚¬í•­

        COMMIT_LIST

        ## ğŸ“ ìˆ˜ì •ëœ íŒŒì¼ë“¤

        CHANGED_FILES

        ## ğŸ” ë°°í¬ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸

        - [ ] ëª¨ë“  ê¸°ëŠ¥ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸
        - [ ] ë¹Œë“œê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ëŠ”ì§€ í™•ì¸
        - [ ] ìºì‹œ ë¬´íš¨í™” ì‹œìŠ¤í…œì´ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸
        - [ ] Open Graph ì´ë¯¸ì§€ê°€ ì˜¬ë°”ë¥´ê²Œ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸
        - [ ] ëª¨ë°”ì¼ ë°˜ì‘í˜•ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸

        ## ğŸš€ ë°°í¬ í›„ í™•ì¸ì‚¬í•­

        - [ ] ë©”ì¸ í˜ì´ì§€ ë¡œë”© í™•ì¸
        - [ ] ë¸”ë¡œê·¸ í˜ì´ì§€ ì •ìƒ ë™ì‘ í™•ì¸
        - [ ] ê´€ë¦¬ì í˜ì´ì§€ ê¸°ëŠ¥ í™•ì¸
        - [ ] SEO ë©”íƒ€íƒœê·¸ ì •ìƒ ì¶œë ¥ í™•ì¸
        - [ ] ì†Œì…œ ë¯¸ë””ì–´ ê³µìœ  ì‹œ OG ì´ë¯¸ì§€ ì •ìƒ í‘œì‹œ í™•ì¸

        ---
        *ì´ PRì€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ¤–*
        EOF

        # ë³€ìˆ˜ ì¹˜í™˜
        sed -i "s/DEPLOY_DATE/${{ steps.date.outputs.current_date }}/g" pr_body_template.md
        sed -i "s/DEPLOY_TIME/${{ steps.date.outputs.current_time }}/g" pr_body_template.md
        sed -i "s|COMMIT_LIST|${{ steps.changes.outputs.commits }}|g" pr_body_template.md
        sed -i "s|CHANGED_FILES|${{ steps.changes.outputs.changed_files }}|g" pr_body_template.md

        # ì™„ì„±ëœ PR ë³¸ë¬¸ì„ outputìœ¼ë¡œ ì„¤ì •
        {
          echo 'pr_body<<EOF'
          cat pr_body_template.md
          echo 'EOF'
        } >> $GITHUB_OUTPUT

    - name: GitHub APIë¡œ PR ìƒì„±
      if: steps.check_existing_pr.outputs.existing_pr_count == '0'
      run: |
        # JSON í˜ì´ë¡œë“œ ìƒì„±
        jq -n \
          --arg title "ğŸš€ MAIN ë°°í¬" \
          --arg head "feature/local" \
          --arg base "main" \
          --arg body "${{ steps.pr_body.outputs.pr_body }}" \
          --argjson draft false \
          '{
            title: $title,
            head: $head,
            base: $base,
            body: $body,
            draft: $draft
          }' > pr_payload.json

        # GitHub APIë¥¼ í†µí•œ PR ìƒì„±
        RESPONSE=$(curl -X POST \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Content-Type: application/json" \
          "https://api.github.com/repos/${{ github.repository }}/pulls" \
          -d @pr_payload.json)

        # ì‘ë‹µ í™•ì¸
        PR_URL=$(echo "$RESPONSE" | jq -r '.html_url // empty')
        if [ -n "$PR_URL" ]; then
          echo "âœ… PRì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸ”— PR URL: $PR_URL"
        else
          echo "âŒ PR ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
          echo "ì‘ë‹µ: $RESPONSE"
          exit 1
        fi

    - name: ê¸°ì¡´ PR ì•Œë¦¼
      if: steps.check_existing_pr.outputs.existing_pr_count != '0'
      run: |
        echo "âš ï¸ feature/local â†’ main PRì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤."
        echo "ğŸ”— ê¸°ì¡´ PR: ${{ steps.check_existing_pr.outputs.existing_pr_url }}"

    - name: PR ìƒì„± ì™„ë£Œ ì•Œë¦¼
      run: |
        echo "ğŸ‰ MAIN ë°°í¬ PRì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ğŸ“… ìƒì„± ì‹œê°„: $(date +'%Y-%m-%d %H:%M:%S')"